# Data Model: Spectra Display

**Feature**: Spectra Display Page  
**Date**: 2025-01-28  
**Phase**: 1 - Design

## Overview

The spectra display feature extends the existing source inventory functionality by adding spectrum visualization and metadata display. The feature introduces new data retrieval patterns and visualization entities but leverages existing database tables and result structures.

## Entities

### Source Identifier (Input)

**Description**: Source identifier used to query and filter spectra from the database

**Properties**:
- `source_name` (str): Source identifier from URL (e.g., "HIP 65426")
  - Format: Decoded from URL path parameter
  - Source: Extracted from `/source/{source_name}/spectra` route
  - Validation: Source must exist in database
  - Required: Yes

**Relationships**:
- Maps to database query via `db.query(db.Spectra).filter(db.Spectra.source == source_name)`
- Used to retrieve all spectra associated with this source

**Constraints**:
- Source name must decode successfully from URL
- Source must exist in database (404 error if not found)

### Spectrum Record (Database Entity)

**Description**: Single spectrum entry from the Spectra table in the database

**Properties** (from astrodbkit query result):
- `source` (str): Source identifier this spectrum belongs to
- `access_url` (str): Spectrum data URL or path (or configured column name)
  - Format: URL string pointing to spectrum file
  - Usage: astrodbkit fetches and formats spectrum data automatically
  - Configuration: Column name customizable via environment variable
- Spectrum data: Wavelength and flux arrays already formatted by astrodbkit
  - Format: Direct access to wavelength and flux data
  - Usage: Plot spectra directly without additional conversion
- `observation_date` (str/datetime): Date of observation
  - Format: ISO 8601 date string or datetime object
  - Display: Show in metadata table and legend, "-" if missing
- `regime` (str): Spectral regime (e.g., "optical", "near-infrared", "mid-infrared")
  - Display: Show in metadata table and legend, "-" if missing
- `telescope` (str): Telescope used for observation (e.g., "JWST", "Keck")
  - Display: Show in metadata table and legend, "-" if missing
- `instrument` (str): Instrument used for observation (e.g., "NIRSpec", "HIRES")
  - Display: Show in metadata table and legend, "-" if missing
- Additional metadata columns as present in database

**Relationships**:
- Belongs to one Source (many-to-one)
- Contains wavelength and flux data accessible via access_url

**Constraints**:
- Source field must match query source_name
- access_url must contain valid spectrum data (some may fail to load)
- At least one spectrum must exist for source (otherwise no spectra page link shown)

### Spectrum Data (Loaded)

**Description**: Wavelength and flux arrays loaded from spectrum file

**Properties**:
- `wavelength` (array): Wavelength values in microns
  - Type: numpy.ndarray or similar
  - Units: microns
  - Usage: X-axis for Bokeh plot
  
- `flux` (array): Flux values (intensity)
  - Type: numpy.ndarray or similar
  - Units: Depends on spectrum (typically erg/s/cm²/Å or similar)
  - Usage: Y-axis for Bokeh plot

**Error Handling**:
- Network timeout (10 second limit)
- Invalid URL (404, 500 errors)
- Unsupported file format
- Corrupt or unreadable data
- Result: Spectrum skipped silently, continue processing others

### Spectrum Metadata (Display Entity)

**Description**: Formatted metadata for display in table and legend

**Properties**:
- `observation_date_str` (str): Formatted observation date
  - Format: ISO date string or "-" if missing
  - Display: In metadata table
  
- `regime_str` (str): Regime identifier
  - Format: Uppercase or capitalized (e.g., "NIR", "optical")
  - Display: In metadata table and legend, "-" if missing
  
- `telescope_str` (str): Telescope identifier
  - Format: Original value or "-" if missing
  - Display: In metadata table and legend
  
- `instrument_str` (str): Instrument identifier
  - Format: Original value or "-" if missing
  - Display: In metadata table and legend
  
- `legend_label` (str): Formatted label for plot legend
  - Format: "observation_date | regime | telescope/instrument"
  - Example: "2020-03-15 | NIR | JWST/NIRSpec"
  - Missing fields shown as "-"
  - Display: In Bokeh plot legend

**Legend Formatting**:
- Combine: observation_date_str + " | " + regime_str + " | " + telescope_str + "/" + instrument_str
- Replace missing fields with "-"
- Example with missing telescope: "2020-03-15 | NIR | -/NIRSpec"
- Example with all missing: "- | - | -/-"

### Spectra Visualization (Output)

**Description**: Complete page data for displaying spectra visualization

**Properties**:
- `source_name` (str): Source identifier for display
- `plot_script` (str): Bokeh plot JavaScript code
  - Format: Embedded HTML <script> tag
  - Generated by: `bokeh.embed.components()`
  - Contains: Plot data, axes, legend, interaction handlers
  
- `plot_div` (str): Bokeh plot HTML container
  - Format: HTML <div> tag with plot canvas
  - Generated by: `bokeh.embed.components()`
  - Positioned: Above or alongside metadata table

- `spectra_metadata` (list[dict]): List of spectrum metadata dictionaries
  - Each dict contains: observation_date, regime, telescope, instrument, access_url (as link)
  - Usage: Rendered in HTML table
  - Order: Same as plot lines (maintains correspondence)

- `spectra_count` (int): Number of spectra successfully loaded and displayed
  - Value: Length of spectra successfully loaded
  - Usage: Display in page heading (e.g., "Spectra (5)")

- `has_spectra` (bool): Whether any spectra were successfully loaded
  - True: At least one spectrum loaded
  - False: All spectra failed to load or none exist
  - Usage: Conditional content (show plot vs. show "No spectra available")

**Display Structure**:
1. Page heading: "Spectra for {source_name} ({spectra_count})"
2. Bokeh plot: Interactive visualization of all spectra
3. Metadata table: Spectrum details with clickable links
4. Navigation: Link back to inventory page

### Spectra Query Response (Internal)

**Description**: Raw database query result before processing

**Properties**:
- `spectra_df` (pandas.DataFrame): All spectra for source from database
  - Columns: source, access_url, observation_date, regime, telescope, instrument, etc.
  - Filtered: By source name
  - Format: pandas DataFrame (from astrodbkit)

**Processing Pipeline**:
1. Query database: `db.query(db.Spectra).filter(...).spectra(fmt='pandas')`
2. Extract metadata columns
3. Fetch spectrum data from access_url
4. Generate Bokeh plot
5. Format metadata table
6. Combine for template rendering

## State Transitions

### Page Load → Spectrum Query → Loading → Display

1. **User Navigation**: User clicks "View Spectra" link from inventory page
   - URL: `/source/{source_name}/spectra`
   - Route: FastAPI handles source_name parameter

2. **Database Query**:
   - Connect to database via astrodbkit
   - Query: `db.query(db.Spectra).filter(db.Spectra.source == source_name).spectra(fmt='pandas')`
   - Result: DataFrame with spectrum records

3. **Visualization Generation**:
   - Create Bokeh figure with axis labels
   - Plot each loaded spectrum as separate line
   - Add legend with formatted labels
   - Generate script and div components

4. **Template Rendering**:
   - Render spectra.html template
   - Embed Bokeh plot (script and div)
   - Display metadata table
   - Show link back to inventory

### Error States

**No Spectra Available**:
- Condition: Database query returns empty DataFrame
- Display: Message "No spectra available for this source"
- Navigation: Link back to inventory page

**All Spectra Failed to Load**:
- Condition: Some spectra queried but all failed to load (invalid URLs, corrupt files, etc.)
- Display: Message "No displayable spectra available"
- Navigation: Link back to inventory page

**Partial Success**:
- Condition: Some spectra load successfully, others fail
- Display: Only successful spectra shown, no error messages
- User Experience: Sees available data without failures

## Validation Rules

### Source Name Validation

- Source name decoded from URL must be non-empty
- Source must exist in database (checked via astrodbkit)
- If source doesn't exist: Return 404 error page

### Spectrum Loading Validation

**URL Validation**:
- access_url must be non-empty string
- Should be valid URL or file path
- Network timeout: 10 seconds maximum

**Format Validation**:
- File must be readable by astrodbkit
- Supported formats: FITS, ASCII (auto-detected by astrodbkit)
- Must contain wavelength and flux arrays accessible after astrodbkit processing

**Data Validation**:
- Wavelength and flux arrays must have same length
- Arrays must be non-empty (at least one data point)
- Data must be numeric

**Error Handling**: Invalid spectra skipped silently, no error messages to user

### Metadata Formatting Validation

**Observation Date**:
- Format: ISO date string (e.g., "2020-03-15")
- Missing: Display as "-"

**Regime**:
- Format: Uppercase or proper case (e.g., "NIR", "Optical")
- Missing: Display as "-"

**Telescope**:
- Format: Original value from database
- Missing: Display as "-"

**Instrument**:
- Format: Original value from database
- Missing: Display as "-"

**Legend Label**:
- Format: "{observation_date} | {regime} | {telescope}/{instrument}"
- Missing fields: Replace with "-" in each position
- Example: "- | NIR | JWST/NIRSpec" (missing date)

## Database Schema

**No schema changes required**:
- Uses existing Spectra table accessed via astrodbkit
- Spectrum columns: source, access_url, observation_date, regime, telescope, instrument
- Additional metadata columns may vary by database

**Existing Columns Used**:
- `source` (str): Source identifier (used for filtering)
- `access_url` (str): Spectrum data URL or path (or configured column)
- `observation_date` (str/datetime): Observation date
- `regime` (str): Spectral regime
- `telescope` (str): Telescope identifier
- `instrument` (str): Instrument identifier
- Additional metadata columns as present

**Column Name Configuration**:
- Spectrum URL column name: `ASTRO_WEB_SPECTRA_URL_COLUMN` environment variable
- Default: `access_url`
- Customizable for different database schemas

## Performance Considerations

### Query Performance

- Database query: Typically <1 second via astrodbkit
- Indexed on source column for fast filtering

### Spectrum Loading

- Individual spectrum files: Typically <1MB, <1 second per file
- Parallel fetching recommended (use asyncio or threading)
- Network timeout: 10 seconds prevents indefinite hanging
- Total loading time: Scales with number of spectra

### Plot Generation

- Bokeh plot creation: <1 second for 10-15 spectra
- Legend generation: Minimal overhead
- Embedding components: <100ms

### Page Load Performance

- Total page load: Within 10 seconds for sources with up to 15 spectra
- Loading indicator: Displayed during spectrum retrieval and processing
- Responsive UI: Show loading state, then render complete page

## Testing Strategy

### Unit Tests

- Source name validation and decoding
- Spectrum metadata extraction from DataFrame
- Legend label formatting with various metadata combinations
- Missing metadata handling ("-" display)
- Configuration variable reading

### Integration Tests

- Full spectrum loading from URL to plot
- Multiple spectrum overlay in single plot
- Error handling for invalid spectrum URLs
- Graceful degradation when no valid spectra load
- Database query execution and result parsing

### Manual Testing

- UI display of plot with legend
- Metadata table rendering and link functionality
- Navigation from inventory to spectra page
- Loading indicator visibility and timing
- Interactive plot features (zoom, pan, reset, legend click-to-hide)
- Display of sources with 0, 1, 5, 10+ spectra

